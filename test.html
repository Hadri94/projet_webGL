<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - lights - spotlight</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>
	<body>

		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> webgl - spotlight by <a href="http://master-domain.com" target="_blank" rel="noopener">Master James</a><br />
		</div>

		<script type="module">

			import * as THREE from './build/three.module.js';
			import { GUI } from './jsm/dat.gui.module.js';
			import { OrbitControls } from './jsm/OrbitControls.js';

			let renderer, scene, camera;
			let spotLight, lightHelper, shadowCameraHelper;
			let gui;
            
            let animationView = false, speed = 0.1, size, anim = 0;

            let chair = {
                seated: {
                    mesh: '',
                    geometry: '',
                    materiel: ''
                },
                back: {
                    mesh: '',
                    geometry: '',
                    materiel: ''
                },
                foot: {
                    mesh: [],
                    geometry: '',
                    materiel: ''
                }
            };

            let ground = {
                mesh: '',
                geometry: '',
                materiel: ''
            }

            let lamp = {
                mesh: [],
            }

			function init() {

				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );

				renderer.shadowMap.enabled = true;
				renderer.shadowMap.type = THREE.PCFSoftShadowMap;
				renderer.outputEncoding = THREE.sRGBEncoding;

				scene = new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.set( 160, 40, 500 );

				const controls = new OrbitControls( camera, renderer.domElement );
				controls.addEventListener( 'change', render );
				controls.minDistance = 20;
				controls.maxDistance = 1000;
				controls.enablePan = false;

				const ambient = new THREE.AmbientLight( 0xffffff, 0.1 );
				scene.add( ambient );




                /** Objet Lumière **/


                /* Création */

                for (let i = 0; i < 2 ; i++) {
                    lamp.mesh[i] = new THREE.SpotLight( 0xffffff, 1 );

                }


                /* Positionnement et Option */

                lamp.mesh[0].position.set( 100, 200, 50 );
                lamp.mesh[1].position.set( 100, 200, -50 );


                for (let i = 0; i < lamp.mesh.length ; i++) { //lamp.mesh.length

                    lamp.mesh[i].intensity = 1.5;
                    lamp.mesh[i].angle = Math.PI / 4;
                    lamp.mesh[i].penumbra = 0.01;
                    lamp.mesh[i].decay = 2;
                    lamp.mesh[i].distance = 500;

                    lamp.mesh[i].castShadow = true;
                    lamp.mesh[i].shadow.mapSize.width = 512;
                    lamp.mesh[i].shadow.mapSize.height = 512;
                    lamp.mesh[i].shadow.camera.near = 10;
                    lamp.mesh[i].shadow.camera.far = 200;

                    scene.add(lamp.mesh[i]);
                }






                /** Objet Sol **/


                /* Création */

                ground.geometry = new THREE.BoxGeometry( 750, 10, 750 );
                ground.materiel = new THREE.MeshPhongMaterial( { color: 0x808080, dithering: true } );
                ground.mesh = new THREE.Mesh( ground.geometry, ground.materiel );


                /* Positionnement */

                ground.mesh.receiveShadow = true;
                ground.mesh.position.set(0, -123, 0);


                /* Ajout sur la scène */

                scene.add(ground.mesh);






				/** Objet Chaise **/


                /* Création */

				chair.seated.geometry = new THREE.BoxGeometry( 100, 10, 100 );
                chair.seated.materiel = new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load( 'textures/osier.jpg' ), dithering: true } );
                chair.seated.mesh = new THREE.Mesh( chair.seated.geometry, chair.seated.materiel );

                chair.back.geometry = new THREE.BoxGeometry( 10, 50, 80  );
                chair.back.materiel = new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load( 'textures/osier.jpg' ), dithering: true } );
                chair.back.mesh = new THREE.Mesh( chair.back.geometry, chair.back.materiel );

                chair.foot.geometry = new THREE.BoxGeometry( 10.10, 130.10, 10.10 );
                chair.foot.materiel = new THREE.MeshPhongMaterial( { map: new THREE.TextureLoader().load( 'textures/aluminium.jpg' ), dithering: true } );
                for (let i = 0; i < 6 ; i++) {
                    chair.foot.mesh[i] = new THREE.Mesh( chair.foot.geometry, chair.foot.materiel );
                }


                /* Positionnement et Option */

                chair.seated.mesh.castShadow = true;
                chair.seated.mesh.receiveShadow = true;

				chair.back.mesh.position.set(45, 75, 0);

                chair.back.mesh.castShadow = true;
                chair.back.mesh.receiveShadow = true;

                chair.foot.mesh[0].position.set(-45, -62.5, -45);
                chair.foot.mesh[1].position.set( 45, -62.5,  45);
                chair.foot.mesh[2].position.set(-45, -62.5,  45);
                chair.foot.mesh[3].position.set( 45, -62.5, -45);

                chair.foot.mesh[4].position.set( 45,  37.5,  45);
                chair.foot.mesh[5].position.set( 45,  37.5, -45);

                for (let i = 0; i < chair.foot.mesh.length ; i++) {
                    chair.foot.mesh[i].castShadow = true;
                    chair.foot.mesh[i].receiveShadow = true;
                }


                /* Ajout sur la scène */

                scene.add(chair.seated.mesh);
                scene.add(chair.back.mesh);
                for (let i = 0; i < chair.foot.mesh.length; i++) {
					scene.add( chair.foot.mesh[i] );					
				}

				//

				

				render();

				window.addEventListener( 'resize', onWindowResize );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function render() {
				renderer.render( scene, camera );
			}

			function buildGui() {

				gui = new GUI();

				const params = {
                    'Position dossier': chair.back.mesh.position.y,
                    'Etat lampe 2': true,
                    'Vue éclatée': false,
				};


                /* Changement du dossier */
                gui.add(params, 'Position dossier', 75, 105).onChange(function(val) {
                    chair.back.mesh.position.set(45, val, 0);
                    chair.foot.mesh[4].position.y = val - 37.5;
                    chair.foot.mesh[5].position.y = val - 37.5;
                    render();
                });

                /* Gestion lampe n°2 */
                gui.add(params, 'Etat lampe 2').onChange(function(val) {
                    lamp.mesh[1].intensity = val ? 1.5 : 0;
                    render();
                });

                /* Vue éclatée */
                gui.add(params, 'Vue éclatée').onChange(function(val) {

                    animationView = val ? true : false;
                    size = val ? 20 : 0;

                    if(!val) chair.seated.mesh.position.set(0, 0, 0);

                    chair.back.mesh.position.set(45 + size, 75 +size, 0);
                
                    chair.foot.mesh[0].position.set(-45, -62.5 + size, -45 - size);
                    chair.foot.mesh[1].position.set( 45, -62.5 + size,  45 + size);
                    chair.foot.mesh[2].position.set(-45, -62.5 + size,  45 + size);
                    chair.foot.mesh[3].position.set( 45, -62.5 + size, -45 - size);

                    chair.foot.mesh[4].position.set( 45 + (size * 2),  37.5 + (size * 2) ,  45 + (size * 2) );
                    chair.foot.mesh[5].position.set( 45 + (size * 2),  37.5 + (size * 2) , -45 - (size * 2) );
                    
                    animate();
                    render();
                });

				gui.open();

			}

            function animate() {

                requestAnimationFrame( animate );


                /* Animation de la chaise lors de l'activation "Vue éclatée" */
                if(animationView) {

                    const cal_1 = size + anim;
                    const cal_2 = cal_1 * 1.2;
                    const cal_3 = cal_1 * 1.3;
                    const cal_4 = cal_1 * 1.4;
                    const cal_5 = cal_1 * 2;

                    chair.seated.mesh.position.set(0 + (anim * 1.3), 0 - anim, 0);

                    chair.back.mesh.position.set(45 + cal_5 , 75 + anim, 0 - (anim / 2));
                
                    chair.foot.mesh[0].position.set(-45, -50 + cal_1, -45 - cal_1);
                    chair.foot.mesh[1].position.set( 45, -50 + cal_3,  45 + cal_4);
                    chair.foot.mesh[2].position.set(-45, -50 + cal_4,  45 + cal_1);
                    chair.foot.mesh[3].position.set( 45, -50 + cal_2, -45 - cal_4);

                    chair.foot.mesh[4].position.set( 45 + cal_2,  50 + cal_1 ,  45 + cal_1 );
                    chair.foot.mesh[5].position.set( 45 + cal_1,  50 + cal_1 , -45 - cal_2 );
                    
                    
                    anim += speed;
                    
                    if(anim > 7.5) speed = -0.03;
                    else if(anim < 0) speed = 0.03;
                    
                    
                }

                renderer.render( scene, camera );
            }

			init();
			buildGui();
			render();

		</script>

	</body>

</html>